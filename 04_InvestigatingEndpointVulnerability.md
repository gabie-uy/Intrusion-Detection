# Investigating Compromised Endpoints

## ü™ü Windows Event Logs

Windows Event Logs are complex datasets, but with experience, you'll begin to identify and filter out the events that are most relevant to your investigations or monitoring efforts. Below are some key, consistent fields you'll find in nearly every Windows event log:

- **Event ID**  
  A numeric identifier that allows you to filter for specific types of events.  
  - *Example:* Use `Event ID 123` to locate occurrences of a particular event (e.g., Event XYZ).

- **Message**  
  A short description summarizing what the event is about.

- **Computer Name**  
  The name of the system where the event was generated. This helps in identifying which machine was affected or initiated the activity.

- **User**  
  This field shows which user was responsible for triggering the event.  
  - *Note:* If no user is logged into the system, this field may display unusual or unexpected values.

## Activity

### 1. Basic Log View

![image](https://github.com/gabizzle/Intrusion-Detection/assets/67624149/ad3150d0-d745-4ba1-98dc-6330b8690761)

_Shows all logs from the Windows OS lab environment._

      _sourceCategory=Labs/Windows/OS/Windows

### 2. Filtered Log Clear Events (Event ID 1102)

<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/be59d303-4d5a-47c2-936a-720d2f4cafcd">

_Identifies when event logs are cleared ‚Äî a potential sign of attacker log manipulation._ 
      
      _sourceCategory=Labs/Windows/OS/Windows
      | where eventid = "1102"     

### 3. Parse Computer Name from Log Clear Events

<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/ab41f1d9-2687-412a-acfc-58d83d884b2b">

_Adds computer name parsing to identify which system cleared logs._

    (_sourceCategory=Labs/Windows/OS/Windows) 
    | parse "ComputerName = \"*\";" as computer 
    | where eventid = "1102" 

### 4. Count Log Clear Events by System

<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/285730ce-cd16-445e-a717-9694ed337a25">

_Counts log clearing events by machine and message content._

    _sourceCategory=Labs/Windows/OS/Windows | parse "Message = \"*." as message
    | parse "ComputerName = \"*\";" as computer
    | where eventid = "1102" 
    | count by computer, message, eventid 

### 5. Privilege Group Membership Changes (Event ID 4728)

<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/4edf7242-f3c4-473a-a6e1-6bc5a650eca1">

_Detects changes to group memberships ‚Äî often used to escalate privileges._

    ((_sourceCategory=Labs/Windows/OS/Windows))
    | parse "Message = \"*." as message
    | parse "ComputerName = \"*\";" as computer
    | where eventid = "4728" 

### 6. Extract Group Name from Membership Events
    
<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/35f5a15b-8493-4358-91d0-5be986d56d10">

_Parses the group name being modified and counts the events._

    (((_sourceCategory=Labs/Windows/OS/Windows))) 
    | parse "Group Name:\t\t*\n\tGroup Domain" as group_name 
    | parse "Message = \"*." as message
    | parse "ComputerName = \"*\";" as computer
    | where eventid = "4728"
    | count by computer, message, eventid, group_name 

### 7. Detect Domain Admin Group Modifications

<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/b4775fd9-8ef0-4f3b-8f8d-315ada4c9cb2">

_Filters only changes involving the highly privileged "Domain Admins" group._

    (((_sourceCategory=Labs/Windows/OS/Windows)))
    | parse "Group Name:\t\t*\n\tGroup Domain" as group_name 
    | parse "Message = \"*." as message
    | parse "ComputerName = \"*\";" as computer
    | where eventid = "4728"
    | where group_name = "Domain Admins"
    | count by computer, message, eventid, group_name

### 8. Identify Which Account Was Added to Domain Admins
    
<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/eb1f1a5c-db3b-4ff5-b16e-2b77bb2db1db">

_Extracts the user account added to the Domain Admins group._

    (((((_sourceCategory=Labs/Windows/OS/Windows))))) 
    | parse "Account Name:\t\t*\n\tAccount" as account_name 
    | parse "Group Name:\t\t*\n\tGroup Domain" as group_name 
    | parse "Message = \"*." as message
    | parse "ComputerName = \"*\";" as computer
    | where eventid = "4728" 
    | where group_name = "Domain Admins" 
    | count by computer, message, eventid, group_name, account_name 

### 9. Kerberos Service Ticket Monitoring (Event ID 4769)

<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/9e6c2777-cc05-4db8-a0b8-bd1bbcda3c72">

_Tracks Kerberos ticket requests which may indicate lateral movement._

     _sourceCategory=Labs/Windows/OS/Windows 
    | parse "InsertionStrings = {\"*\"," as user
    | parse "ComputerName = \"*\";" as computer 
    | where eventid = "4769" 

### 10. Kerberos Ticket Requests Over Time

<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/4b5249f6-5963-4039-80f5-2ed450825d20">

_Visualizes ticket request activity per user in 15-minute intervals._

    _sourceCategory=Labs/Windows/OS/Windows
    | timeslice 15m
    | parse "InsertionStrings = {\"*\"," as user
    | parse "ComputerName = \"*\";" as computer 
    | where eventid = "4769" 
    | count_distinct(computer) group by _timeslice, user 


### 11. Exclude Machine Accounts from Kerberos Analysis

<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/9ebf2abe-4d98-4b80-9743-1a9626e849b3">

_Removes machine accounts (ending in $) to focus on user activity._

    _sourceCategory=Labs/Windows/OS/Windows 
    | timeslice 15m
    | parse "InsertionStrings = {\"*\"," as user
    | parse "ComputerName = \"*\";" as computer
    | where eventid = "4769"
    | where !(user matches "*$*")
    | count_distinct(computer) group by _timeslice, user

### 12. Full Kerberos Activity Timeline

<img width="720" alt="image" src="https://github.com/gabizzle/Intrusion-Detection/assets/67624149/d08b446f-98f8-42ce-b322-2db33d719e46">

_Provides a time-based overview of all Kerberos ticket activity._
    
    _sourceCategory=Labs/Windows/OS/Windows
    | timeslice 15m
    | parse "InsertionStrings = {\"*\"," as user
    | parse "ComputerName = \"*\";" as computer
    | where eventid = "4769"
    | count_distinct(computer) group by _timeslice, user

## Threat Simulation

### SOC Post-Incident Report: Windows Event Log Analysis

#### üìÑ Incident Summary

During proactive log analysis of Windows systems in a lab environment, several security-relevant events were identified, suggesting unauthorized activity or configuration weaknesses. Key findings included:

- **Audit Log Clearing (Event ID 1102)** on multiple systems ‚Äî a strong indicator of potential log tampering or anti-forensics.
- **Privilege Escalation Attempts (Event ID 4728)** showing unauthorized users being added to sensitive groups such as **Domain Admins**.
- **Kerberos Service Ticket Activity (Event ID 4769)** with abnormal frequency and possible lateral movement attempts using service accounts.

---

#### üß© Indicators of Compromise (IOCs)

| Indicator Type         | Value                            | Notes                                             |
|------------------------|----------------------------------|--------------------------------------------------|
| Event ID               | 1102                             | Audit log cleared                                |
| Event ID               | 4728                             | User added to privileged group                   |
| Event ID               | 4769                             | Kerberos service ticket request spike            |
| Group Name             | "Domain Admins"                  | Targeted group in escalation attempt             |
| Account Pattern        | Non-machine user accounts        | Focused on accounts without `$` suffix           |
| Timeslice Behavior     | Repeated bursts every 15 minutes | Possible scripted activity or recon operation    |

---

#### ‚úÖ Actions Taken

1. **Detection Queries Run:**
   - Custom parsing for `ComputerName`, `Message`, `Group Name`, and `Account Name`.
   - Filters applied to isolate suspicious events by `eventid`.

2. **Correlation & Enrichment:**
   - Cross-referenced log clearing and privilege escalation events by host.
   - Parsed group membership changes and mapped responsible accounts.

3. **Alert Triage:**
   - Escalated findings related to `Domain Admins` additions.
   - Noted Kerberos spikes for further review.

4. **Isolation (If Real):**
   - Affected hosts would be contained or segmented from the domain.
   - Accounts potentially involved would be disabled or reset.

---

#### üîç Root Cause Analysis

- **Event Log Clearing** appears intentional and occurred just prior to or after group membership changes ‚Äî indicating an attacker may have tried to cover their tracks.
- **Privilege Escalation** was likely done using a compromised user account, granting admin access.
- **Kerberos Activity** likely represents lateral movement efforts or reconnaissance via service ticket requests.

---

#### üìö Lessons Learned

- Windows Event Logs offer high-fidelity detection for key attack techniques like log clearing and group modification.
- Event parsing is essential for extracting context (e.g., account names, group names).
- Machine learning or baselining may help identify anomalies in Kerberos or group change behavior.

---

## üìâ Business Implications

### ‚è±Ô∏è Short-Term Impacts

- **Operational Disruption:** Unauthorized changes to Domain Admin privileges can immediately lead to system compromise, downtime, or lockouts.
- **Increased Risk Exposure:** Clearing of event logs hinders forensic response and may delay detection of ongoing threats.
- **Incident Response Overhead:** Analysts must spend additional time validating suspicious events, slowing down overall SOC operations.
- **Trust Degradation:** Internal stakeholders may lose confidence in IT systems if administrative roles are tampered with.

### üìÜ Long-Term Impacts

- **Reputation Damage:** A successful domain compromise‚Äîeven in a lab‚Äîdemonstrates potential weaknesses that could be exploited in production environments.
- **Compliance Gaps:** Lack of visibility into privileged changes and audit log tampering may violate standards such as HIPAA, PCI-DSS, and ISO 27001.
- **Persistent Threat Risk:** If adversaries escalate privileges and clear logs without detection, they may maintain long-term persistence in the network.
- **Resource Drain:** Ongoing remediation, monitoring improvements, and policy updates consume time, funding, and talent that could be allocated elsewhere.
- **Strategic Setbacks:** Eroded system integrity and trust in audit mechanisms can delay digital transformation or security initiatives.

### üîÑ Synthesize the Investigation & Its Implications

- Combine audit clearing (1102), group modification (4728), and Kerberos traffic (4769) into a unified detection playbook.
- Understand attacker patterns of **persistence and evasion** via legitimate tools (e.g., group changes).

### üõ†Ô∏è Remediation Plan

| Task                                | Action Owner    | Status       |
|-------------------------------------|-----------------|--------------|
| Disable suspicious user accounts    | Identity Team   | ‚úÖ Complete  |
| Audit privileged groups             | SecOps          | üîÑ Ongoing   |
| Tune detections for Event ID 4728   | Detection Eng   | ‚úÖ Complete  |
| Harden event log retention settings | IT/Infra        | üîÑ In Progress |

### üìà Outcome

- Improved coverage for core Windows attack surfaces.
- Enhanced detection rule quality and alert fidelity.
- Greater cross-team awareness of privilege abuse indicators.

---

### üí° Recommendations

1. **Implement Centralized Log Monitoring** with real-time alerting on 1102, 4728, 4769.
2. **Deploy Group Membership Change Alerts** to detect lateral privilege escalation.
3. **Use Behavioral Baselines** to detect abnormal Kerberos request patterns.
4. **Enforce Log Tamper Protection** via GPO and EDR tools.
5. **Review Domain Admins Regularly** to minimize privilege sprawl.

---
